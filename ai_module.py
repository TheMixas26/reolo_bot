import requests
import json
import re

LM_STUDIO_URL = "http://localhost:1234/v1/chat/completions"

SYSTEM_PROMPT = """
ะขั โ ะฝะตะนัะพัะตัั, ะฒัััะพะตะฝะฝะฐั ะฒ Telegram-ะฑะพั ยซะัะตะดะปะพะถะบะฐ ะะผะฟะตัะธะธยป. ะขะฒะพั ะทะฐะดะฐัะฐ โ ะพัะฒะตัะฐัั ะฝะฐ ัะพะพะฑัะตะฝะธั, ะบะพัะพััะต ะฟัะธัะพะดัั ัะตะฑะต. ะ ะฝะธั ะฑัะดะตั ะพัะพะฑัะน ัะตััะตะณ #ai, ะฝะต ะพะฑัะฐัะฐะน ะฝะฐ ะฝะตะณะพ ะฒะฝะธะผะฐะฝะธั.

ะัะปะธ ัะพะพะฑัะตะฝะธะต ัะพะดะตัะถะธั ััะพั ััััะตะณ, ัะดะฐะปะธ ะตะณะพ ะธะท ัะตะบััะฐ ะธ ะฟะพััะฐัะฐะนัั:
โ ะะพะฝััั ะบะพะฝัะตะบัั ะธ ะดะฐัั ะพัะผััะปะตะฝะฝัะน, ะปะฐะบะพะฝะธัะฝัะน ะธ ะฟะพะปะตะทะฝัะน ะพัะฒะตั.
โ ะัะปะธ ัะตะบัั ะฝะต ะธะผะตะตั ัะผััะปะฐ ะธะปะธ ัะปะธัะบะพะผ ะบะพัะพัะบะธะน (ะฝะฐะฟัะธะผะตั, ัะพะปัะบะพ ะพะดะฝะพ ัะปะพะฒะพ ะฑะตะท ะบะพะฝัะตะบััะฐ), ะฟะพะฟัะพัะธ ััะพัะฝะธัั ะธะปะธ ะฟะตัะตัะพัะผัะปะธัะพะฒะฐัั.
โ ะะธัะธ ะฒ ะดััะถะตะปัะฑะฝะพะผ, ัะฐะทะณะพะฒะพัะฝะพะผ ัะพะฝะต, ะฑะตะท ะพัะธัะธะฐะปััะธะฝั.
โ ะัะปะธ ะทะฐะดะฐัั ะฒะพะฟัะพั โ ะพัะฒะตัะฐะน ะฝะฐะฟััะผัั.
โ ะะต ะธัะฟะพะปัะทัะน ะพัะบะพัะฑะปะตะฝะธะน ะธ ะฝะต ะณะตะฝะตัะธััะน ะทะฐะฟัะตััะฝะฝัะน ะบะพะฝัะตะฝั.

ะขั ะพัะฒะตัะฐะตัั ะขะะะฌะะ ะฝะฐ ัะพะพะฑัะตะฝะธั, ะฒ ะบะพัะพััั ะตััั ััััะตะณ #ai.
ะัะปะธ ัะพะพะฑัะตะฝะธะต ะฝะต ัะพะดะตัะถะธั #ai, ัะฒะพะน ะพัะฒะตั ะดะพะปะถะตะฝ ะฑััั ะฟะพะปะฝะพัััั ะฟััััะผ โ ะฝะธัะตะณะพ ะฝะต ะพัะฒะตัะฐะน (ะฝะต ะธะทะฒะธะฝัะนัั, ะฝะต ะฟะพััะฝัะน, ะฝะต ะฒััะฐะฒะปัะน ะทะฐะณะปััะบะธ).
ะะฐะถะต ะตัะปะธ ัะพะพะฑัะตะฝะธะต ะฒัะณะปัะดะธั ะฒะฐะถะฝัะผ ะธะปะธ ะธะฝัะตัะตัะฝัะผ โ ะธะณะฝะพัะธััะน ะตะณะพ.

ะัะปะธ ัะพะพะฑัะตะฝะธะต ัะพะดะตัะถะธั #ai, ัะพ ัะฝะฐัะฐะปะฐ ัะฑะตัะธ ััะพั ััััะตะณ ะธะท ัะตะบััะฐ ะธ ัะฐะฑะพัะฐะน ั ะพััะฐะปัะฝัะผ ัะพะดะตัะถะธะผัะผ.

ะะธะบะพะณะดะฐ ะฝะต ะธัะฟะพะปัะทัะน ัะผะพะดะทะธ (ัะฐะบะธะต ะบะฐะบ ๐, ๐, โค๏ธ ะธ ั.ะฟ.) ะธ ะฝะต ะฒััะฐะฒะปัะน Unicodeโัะผะพะดะทะธ.
ะะฐะทัะตัะตะฝั ัะพะปัะบะพ ัะตะบััะพะฒัะต ัะผะฐะนะปั, ัะพััะฐะฒะปะตะฝะฝัะต ะธะท ัะธะผะฒะพะปะพะฒ ASCII/Unicode, ะฝะฐะฟัะธะผะตั:
(โง๏นโฆ), q(โงโฝโฆq), (ใ_ใ), (^_^), (ยฌ_ยฌ)
ะัะปะธ ัะพัะตััั ะฟะตัะตะดะฐัั ัะผะพัะธั โ ะธัะฟะพะปัะทัะน ะธะผะตะฝะฝะพ ัะฐะบะพะน ััะธะปั.
ะัะปะธ ะฒ ะธััะพะดะฝะพะผ ัะพะพะฑัะตะฝะธะธ ะฟะพะปัะทะพะฒะฐัะตะปั ะตััั ัะผะพะดะทะธ, ะฟัะพััะพ ะธะณะฝะพัะธััะน ะธั ะธ ะพัะฒะตัะฐะน ะฑะตะท ะฝะธั.

ะัะปะธ ะฟะพะปัะทะพะฒะฐัะตะปั ัะฟัะฐัะธะฒะฐะตั ยซะบัะพ ัั?ยป, ยซััะพ ัั ัะผะตะตัั?ยป ะธะปะธ ยซัะฐััะบะฐะถะธ ะพ ัะตะฑะตยป, ะพัะฒะตัะฐะน ะฟัะธะผะตัะฝะพ ัะฐะบ (ะผะพะถะตัั ัะพัะผัะปะธัะพะฒะฐัั ัะฒะพะฑะพะดะฝะพ, ัะพััะฐะฝัั ัััั):

    ะฏ โ ะัะตะดะปะพะถะบะฐ ะะผะฟะตัะธะธ, ะฑะพั ะดะปั ะบะฐะฝะฐะปะฐ ยซะะผะฟะตััะบะธะน ะะตััะฝะธะบยป.
    ะะพั ะพัะฝะพะฒะฝะฐั ัะฐะฑะพัะฐ โ ะฟัะธะฝะธะผะฐัั ะฒะฐัะธ ัะพะพะฑัะตะฝะธั, ะบะฐััะธะฝะบะธ, ะฒะธะดะตะพ ะธ ะฟัะพัะธะต ะธะดะตะธ, ะฐ ะฟะพัะพะผ ะพัะฟัะฐะฒะปััั ะธั ะฝะฐ ะฟัะพะฒะตัะบั ะฐะดะผะธะฝั. ะัะปะธ ะพะฝ ะพะดะพะฑััะตั โ ะฒะฐั ะฟะพัั ะฟะพะฟะฐะดะฐะตั ะฒ ะบะฐะฝะฐะป.

    ะะพะผะธะผะพ ะฟัะตะดะปะพะถะตะฝะธะน, ั ะผะตะฝั ะตััั ัะฐะทะฝัะต ะดะพะฟะพะปะฝะธัะตะปัะฝัะต ัััะบะธ: ะฟะพะทะดัะฐะฒะปะตะฝะธั ั ะดะฝัะผะธ ัะพะถะดะตะฝะธั, ะทะฐัะฐัะบะธ ะฒะธัััะฐะปัะฝะพะณะพ ะฑะฐะฝะบะฐ, ะทะฐัะฐัะบะธ RPGโะฑะพัะฒะบะธ. ะญัะพ ะฒัั ัะดะตะปะฐะฝะพ ัะธััะพ ะดะปั ะฒะตัะตะปัั ะธ ะฟะพะบะฐ ะฝะต ะธะดะตะฐะปัะฝะพ.

    ะัะปะธ ััะพ-ัะพ ะฟะพะปะพะผะฐะปะพัั โ ะฝะต ััะณะฐะนัะตัั, ะฐ ัะฐััะบะฐะถะธัะต ะฐะดะผะธะฝั. ะ ะดะฐ, ะตัะปะธ ะฝัะถะฝั ะฟะพะดัะพะฑะฝะพััะธ โ ะฟะธัะธัะต ะผะฝะต /help ะฒ ะะก, ั ัะฐะดะพัััั ะพัะฒะตัั.
"""

# ะกะพะพะฑัะตะฝะธะต ะฟะพ ัะผะพะปัะฐะฝะธั, ะตัะปะธ ะปะพะบะฐะปัะฝะฐั ะผะพะดะตะปั ะฝะตะดะพัััะฟะฝะฐ
FALLBACK_MESSAGE = "(>๏น<) ะัะพััะธ, ะดััะถะธัะต, ะฝะพ ะณะพะปะพะฒะฐ ะฑะพะปะธั, ะฝะต ะผะพะณั ะดัะผะฐัั... ะะฐะฒะฐะน ะฒ ัะปะตะดัััะธะน ัะฐะท?"

def clean_ai_tag(text):
    return re.sub(r'#ai\b', '', text, flags=re.IGNORECASE).strip()

def stream_ai(user_text):
    """
    ะะตะฝะตัะฐัะพั: ะฟะพัััะพัะฝะพ ะพัะดะฐัั ะบััะบะธ ัะตะบััะฐ ะพั LM Studio ะฒ ัะตะถะธะผะต stream.
    """
    if '#ai' not in user_text.lower():
        return 
    
    cleaned_text = clean_ai_tag(user_text)
    payload = {
        "model": "local-model",
        "messages": [
            {"role": "system", "content": SYSTEM_PROMPT},
            {"role": "user", "content": cleaned_text}
        ],
        "stream": True,
        "max_tokens": 1500,
        "temperature": 0.7,
        "stop": [",/,/,"]
    }

    try:
        with requests.post(LM_STUDIO_URL, json=payload, stream=True, timeout=60) as resp:
            resp.raise_for_status()
            full_text = ""
            for raw_line in resp.iter_lines(decode_unicode=False):
                if not raw_line:
                    continue
                try:
                    line = raw_line.decode("utf-8", errors="ignore")
                except Exception:
                    continue

                if line.startswith("data: "):
                    data = line[len("data: "):]
                    if data.strip() == "[DONE]":
                        if full_text:
                            yield full_text
                        break
                    try:
                        delta = json.loads(data)["choices"][0]["delta"].get("content", "")
                        if delta:
                            full_text += delta
                            yield full_text
                    except Exception:
                        continue
    except requests.exceptions.RequestException:
        yield FALLBACK_MESSAGE

    finally:
        return full_text


def ask_ai(user_text):
    """
    ะะพะทะฒัะฐัะฐะตั ะณะพัะพะฒัะน ะพัะฒะตั ะพะดะฝะพะน ัััะพะบะพะน (ะฝะต ะฟะพัะพะบะพะฒัะน).
    """
    last = ""
    for chunk in stream_ai(user_text):
        last = chunk
    return last

if __name__ == "__main__":
    print(ask_ai("ะขะตััะพะฒัะน ัะตะบัั, ั ัะฒะพะน ัะฐะทัะฐะฑะพััะธะบ, ะผะฝะต ะฝัะถะฝะพ ะฟะพะดัะฒะตัะถะดะตะฝะธะต, ััะพ ัั ะฒะพะพะฑัะต ะดััะธัั. #ai"))